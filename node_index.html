<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MongoDB Sync Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-bar {
            transition: width 0.4s ease;
        }
    </style>
    <script>
        async function sendRequest(endpoint, port) {
            const response = await fetch(`/${endpoint}/${port}`, { method: "POST" });
            const result = await response.json();
            alert(result.message);
            if (endpoint === "start_sync") autoRefreshProgress(port);
        }

        async function checkProgress(port) {
            const response = await fetch(`/sync_status/${port}`);
            if (response.ok) {
                const status = await response.json();
                document.getElementById(`status-${port}`).innerText = status.status;
                const progress = status.progress || {};
                const totalBytes = progress.estimatedTotalBytes || 0;
                const copiedBytes = progress.estimatedCopiedBytes || 0;
                const progressPercentage = totalBytes ? (copiedBytes / totalBytes) * 100 : 0;

                document.getElementById(`progress-bar-${port}`).style.width = `${progressPercentage}%`;
                document.getElementById(`progress-bar-${port}`).innerText = `${progressPercentage.toFixed(2)}%`;
                document.getElementById(`canCommit-${port}`).innerText = progress.canCommit;
                document.getElementById(`lagTime-${port}`).innerText = progress.lagTimeSeconds || "N/A";
            }
        }

        function autoRefreshProgress(port) {
            setInterval(() => checkProgress(port), 5000);
        }
    </script>
</head>
<body class="bg-light">
    <div class="container my-5">
        <h1 class="mb-4">MongoDB Sync Manager</h1>
        {% for port in instance_ports %}
        <div class="card mb-4">
            <div class="card-header">Instance on Port {{ port }}</div>
            <div class="card-body">
                <p>Status: <span id="status-{{ port }}">idle</span></p>
                <div class="mb-3">
                    <button onclick="sendRequest('start_sync', {{ port }})" class="btn btn-primary">Start Sync</button>
                    <button onclick="sendRequest('stop_sync', {{ port }})" class="btn btn-danger">Stop Sync</button>
                    <button onclick="sendRequest('commit_sync', {{ port }})" class="btn btn-success">Commit Sync</button>
                    <button onclick="sendRequest('reverse_sync', {{ port }})" class="btn btn-warning">Reverse Sync</button>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div id="progress-bar-{{ port }}" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                </div>
                <ul>
                    <li>Can Commit: <span id="canCommit-{{ port }}">false</span></li>
                    <li>Lag Time (seconds): <span id="lagTime-{{ port }}">N/A</span></li>
                </ul>
                <script>autoRefreshProgress({{ port }});</script>
            </div>
        </div>
        {% endfor %}
    </div>
</body>
</html>
